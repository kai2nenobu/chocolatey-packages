import-module au

$fixedVersion = @'
[
  {
    "url": "https://api.github.com/repos/yuru7/HackGen/releases/27117041",
    "assets_url": "https://api.github.com/repos/yuru7/HackGen/releases/27117041/assets",
    "upload_url": "https://uploads.github.com/repos/yuru7/HackGen/releases/27117041/assets{?name,label}",
    "html_url": "https://github.com/yuru7/HackGen/releases/tag/v2.0.0",
    "id": 27117041,
    "node_id": "MDc6UmVsZWFzZTI3MTE3MDQx",
    "tag_name": "v2.0.0",
    "target_commitish": "master",
    "name": "v2.0.0",
    "draft": false,
    "author": {
      "login": "yuru7",
      "id": 13458509,
      "node_id": "MDQ6VXNlcjEzNDU4NTA5",
      "avatar_url": "https://avatars0.githubusercontent.com/u/13458509?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/yuru7",
      "html_url": "https://github.com/yuru7",
      "followers_url": "https://api.github.com/users/yuru7/followers",
      "following_url": "https://api.github.com/users/yuru7/following{/other_user}",
      "gists_url": "https://api.github.com/users/yuru7/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/yuru7/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/yuru7/subscriptions",
      "organizations_url": "https://api.github.com/users/yuru7/orgs",
      "repos_url": "https://api.github.com/users/yuru7/repos",
      "events_url": "https://api.github.com/users/yuru7/events{/privacy}",
      "received_events_url": "https://api.github.com/users/yuru7/received_events",
      "type": "User",
      "site_admin": false
    },
    "prerelease": false,
    "created_at": "2020-05-23T02:34:40Z",
    "published_at": "2020-06-02T00:49:15Z",
    "assets": [
      {
        "url": "https://api.github.com/repos/yuru7/HackGen/releases/assets/21269922",
        "id": 21269922,
        "node_id": "MDEyOlJlbGVhc2VBc3NldDIxMjY5OTIy",
        "name": "HackGenNerd_v2.0.0.zip",
        "label": null,
        "uploader": {
          "login": "yuru7",
          "id": 13458509,
          "node_id": "MDQ6VXNlcjEzNDU4NTA5",
          "avatar_url": "https://avatars0.githubusercontent.com/u/13458509?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/yuru7",
          "html_url": "https://github.com/yuru7",
          "followers_url": "https://api.github.com/users/yuru7/followers",
          "following_url": "https://api.github.com/users/yuru7/following{/other_user}",
          "gists_url": "https://api.github.com/users/yuru7/gists{/gist_id}",
          "starred_url": "https://api.github.com/users/yuru7/starred{/owner}{/repo}",
          "subscriptions_url": "https://api.github.com/users/yuru7/subscriptions",
          "organizations_url": "https://api.github.com/users/yuru7/orgs",
          "repos_url": "https://api.github.com/users/yuru7/repos",
          "events_url": "https://api.github.com/users/yuru7/events{/privacy}",
          "received_events_url": "https://api.github.com/users/yuru7/received_events",
          "type": "User",
          "site_admin": false
        },
        "content_type": "application/x-zip-compressed",
        "state": "uploaded",
        "size": 44005017,
        "download_count": 2367,
        "created_at": "2020-06-02T00:39:51Z",
        "updated_at": "2020-06-02T00:40:19Z",
        "browser_download_url": "https://github.com/yuru7/HackGen/releases/download/v2.0.0/HackGenNerd_v2.0.0.zip"
      },
      {
        "url": "https://api.github.com/repos/yuru7/HackGen/releases/assets/21269911",
        "id": 21269911,
        "node_id": "MDEyOlJlbGVhc2VBc3NldDIxMjY5OTEx",
        "name": "HackGen_v2.0.0.zip",
        "label": null,
        "uploader": {
          "login": "yuru7",
          "id": 13458509,
          "node_id": "MDQ6VXNlcjEzNDU4NTA5",
          "avatar_url": "https://avatars0.githubusercontent.com/u/13458509?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/yuru7",
          "html_url": "https://github.com/yuru7",
          "followers_url": "https://api.github.com/users/yuru7/followers",
          "following_url": "https://api.github.com/users/yuru7/following{/other_user}",
          "gists_url": "https://api.github.com/users/yuru7/gists{/gist_id}",
          "starred_url": "https://api.github.com/users/yuru7/starred{/owner}{/repo}",
          "subscriptions_url": "https://api.github.com/users/yuru7/subscriptions",
          "organizations_url": "https://api.github.com/users/yuru7/orgs",
          "repos_url": "https://api.github.com/users/yuru7/repos",
          "events_url": "https://api.github.com/users/yuru7/events{/privacy}",
          "received_events_url": "https://api.github.com/users/yuru7/received_events",
          "type": "User",
          "site_admin": false
        },
        "content_type": "application/x-zip-compressed",
        "state": "uploaded",
        "size": 40426955,
        "download_count": 1617,
        "created_at": "2020-06-02T00:39:24Z",
        "updated_at": "2020-06-02T00:39:51Z",
        "browser_download_url": "https://github.com/yuru7/HackGen/releases/download/v2.0.0/HackGen_v2.0.0.zip"
      }
    ],
    "tarball_url": "https://api.github.com/repos/yuru7/HackGen/tarball/v2.0.0",
    "zipball_url": "https://api.github.com/repos/yuru7/HackGen/zipball/v2.0.0",
    "body": "🚀 [Nerd Fonts](https://www.nerdfonts.com/) を合成した HackGenNerd/HackGen35Nerd をリリースしました。これにより Font Awesome を初めとした多くのアイコンフォントが表示されます。ファイル名が `HackGenNerd_vx.x.x.zip` となっているアーカイブが Nerd Fonts 合成版となります。\r\n🐛 HackGen/HackGen35 (Console 版ではない) において一部の数学記号が半角になっていた問題を修正\r\n🔧 Powerline 記号は Hack フォントに標準で含まれていたため、HackGen Console for Powerline フォントは同梱を終了\r\n🔧 一部のヒンティングを調整"
  }
]
'@

function global:au_GetLatest {
  ## Find a latest release and extract zip URL from GitHub Releases
  #$releases = 'https://api.github.com/repos/yuru7/HackGen/releases'
  #$releases_info = Invoke-RestMethod -Uri $releases
  $releases_info = ($fixedVesion | ConvertFrom-Json)
  foreach ($release in $releases_info) {
    $tag = $release.tag_name
    if ($release.prerelease) {
      Write-Warning ('Ignore prerelease version: "{0}"' -f $tag)
      continue
    }
    if (-not ($tag -match '^v[0-9]+\.[0-9]+\.[0-9]+')) {
      Write-Warning ('Ignore invalid tag name: "{0}"' -f $tag)
      continue
    }
    $url = $release.assets | Where-Object { $_.name -eq "HackGen_${tag}.zip" } | Select-Object -First 1 -Expand browser_download_url
    return @{
      Tag = $tag
      Version = $tag -replace "^v",""
      URL32 = $url
    }
  }
}

function global:au_SearchReplace {
   @{
        ".\hackgen.nuspec" = @{
          '(/HackGen/blob/)[^/<]*' = "`${1}$($Latest.Tag)"
          '(/HackGen/releases/tag/)[^/<]*' = "`${1}$($Latest.Tag)"
        }
        ".\tools\ChocolateyInstall.ps1" = @{
          '(hackgenVersion\s*=).*' = "`${1} '$($Latest.Tag)'"
          '(Checksum\s*=).*' = "`${1} '$($Latest.Checksum32)'"
        }
    }
}

Update-Package -NoReadme
